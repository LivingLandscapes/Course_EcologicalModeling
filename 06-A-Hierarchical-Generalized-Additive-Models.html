<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Hierarchical Generalized Additive Models</title>

<script src="site_libs/header-attrs-2.27/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Data Exploration
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01-A-data-exploration.html">Lab</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Linear Models
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="02-A-linear-models-and-probability-distributions.html">Lab</a>
    </li>
    <li>
      <a href="02-B-Homework-01.html">Homework 1</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Model Selection
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="03-A-model-selection.html">Lab</a>
    </li>
    <li>
      <a href="03-B-Homework-02.html">Homework 2</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Autocorrelation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="04-A-Autocorrelation.html">Lab</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Mixed Models
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="05-A-Linear-Mixed-Models.html">Lab: Linear Mixed Models</a>
    </li>
    <li>
      <a href="05-B-Generalized-Linear-Mixed-Models.html">Lab: Generalized Linear Mixed Models</a>
    </li>
    <li>
      <a href="05-C-Homework-03.html">Homework 3</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    HGAMs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="06-A-Hierarchical-Generalized-Additive-Models.html">Lab: HGAMs</a>
    </li>
    <li>
      <a href="06-B-Homework-04.html">Homework 4</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Hierarchical Generalized Additive
Models</h1>

</div>


<p><strong>Assigned Reading:</strong></p>
<ul>
<li>Pedersen, E. J., Miller, D. L., Simpson, G. L., &amp; Ross, N.
(2019). Hierarchical generalized additive models in ecology: an
introduction with mgcv. PeerJ, 7, e6876.</li>
<li>Lawton, D., Scarth, P., Deveson, E., Piou, C., Spessa, A., Waters,
C., &amp; Cease, A. J. (2022). Seeing the locust in the swarm:
accounting for spatiotemporal hierarchy improves ecological models of
insect populations. Ecography, 2022(2).</li>
</ul>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>To learn about hierarchical generalized additive models (HGAMs), we
are going to use weather station data from grassland ecoregions in the
Great Plains, USA. We will be asking if two factors that affect fire
intensity, <em>minimum relative humidity</em> and <em>maximum wind
speed</em>, are changing between 2010 and 2019.</p>
<p>
<div class="float">
<img
src="https://github.com/LivingLandscapes/Course_EcologicalModeling/raw/master/images/RS.jpg"
width="300" alt="Photo credit: Christine Chitwood" />
<div class="figcaption">Photo credit: Christine Chitwood</div>
</div>
<p>
<p>A brief description of the data:</p>
<ul>
<li>Year = years from 2010 - 2019</li>
<li>Month = numeric code for months May - Sept</li>
<li>Day = Julian day of year</li>
<li>Veg_Type = rangeland ecoregion</li>
<li>Lat = latitude</li>
<li>Long = longitude</li>
<li>Station_ID = weather station unique identifier code</li>
<li>RH_per_min = minimum percent relative humidity between 0600 - 1800
per day</li>
<li>Wind_mph_max = maximum wind speed (mph) between 0600 - 1800 per
day</li>
</ul>
<pre><code>## package &#39;BH&#39; successfully unpacked and MD5 sums checked
## package &#39;patchwork&#39; successfully unpacked and MD5 sums checked
## package &#39;mvnfast&#39; successfully unpacked and MD5 sums checked
## package &#39;ggokabeito&#39; successfully unpacked and MD5 sums checked
## package &#39;gratia&#39; successfully unpacked and MD5 sums checked</code></pre>
<div id="data-exploration" class="section level3">
<h3>Data Exploration</h3>
<p><strong>On your own, familiarize yourself with the data.</strong>
Below, you can see that we’re deadling with &gt;100k rows and
<em>many</em> potential grouping variables.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Number of columns and rows?</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">dim</span>(weather) <span class="co"># &gt;100k rows!</span></span></code></pre></div>
<pre><code>## [1] 104712      9</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># How many unique values in each column?</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>weather <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">length</span>(<span class="fu">unique</span>(.x))))</span></code></pre></div>
<pre><code>## # A tibble: 1 × 9
##    Year Veg_Type Station_ID   Lat  Long Month   Day Wind_mph_max RH_per_min
##   &lt;int&gt;    &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;        &lt;int&gt;      &lt;int&gt;
## 1    10        7         71    71    70     5   153          146       7156</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Some preparations for mgcv</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>weather <span class="ot">&lt;-</span> </span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  weather <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(Veg_Type, Station_ID), </span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>                as.factor)) <span class="sc">%&gt;%</span> <span class="co"># mgcv wants factors for random effect </span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RH_per_min =</span> RH_per_min <span class="sc">+</span> <span class="fl">0.001</span>,</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>         <span class="at">Wind_mph_max =</span> Wind_mph_max <span class="sc">+</span> <span class="fl">0.001</span>) <span class="sc">%&gt;%</span> <span class="co"># for log link</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(Year, Day, Lat, Long),</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>                <span class="sc">~</span> (.x <span class="sc">-</span> <span class="fu">mean</span>(.x)) <span class="sc">/</span> <span class="fu">sd</span>(.x),</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>                <span class="at">.names =</span> <span class="st">&quot;{.col}_scaled&quot;</span>)) <span class="co"># scale covariates</span></span></code></pre></div>
</div>
<div id="random-intercept-model-g" class="section level3">
<h3>“Random Intercept”: Model G</h3>
<p>Let’s first try the simplest HGAM: estimate a single global function
for our covariate of interest (Year) plus a individual-level random
effect intercept for ecoregion. <strong>On your own, investigate each
model diagnostic call (commented out in the chunk below) and
interpret.</strong> Look at the R help for more information, and ask
Caleb if you have more questions.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Create model G using bam()</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>rh_modG <span class="ot">&lt;-</span> </span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="fu">bam</span>(RH_per_min <span class="sc">~</span> <span class="fu">s</span>(Year) <span class="sc">+</span> </span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>        <span class="fu">s</span>(Day, <span class="at">bs =</span> <span class="st">&quot;cc&quot;</span>) <span class="sc">+</span> <span class="co"># Note cubic regression spline</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>        <span class="fu">te</span>(Long, Lat) <span class="sc">+</span> <span class="co"># tensor smooth lets latitude/longitude &#39;interact&#39;</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>        <span class="fu">s</span>(Veg_Type, <span class="at">bs =</span> <span class="st">&quot;re&quot;</span>), <span class="co"># Random effect for ecoregion</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="st">&quot;log&quot;</span>), <span class="co"># Why this link?!</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>      <span class="at">data =</span> weather,</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">&quot;fREML&quot;</span>) <span class="co"># need to use fREML for fast fitting.</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co"># # Some basic model diagnostics</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="co"># summary(rh_modG)</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="co"># gam.check(rh_modG)</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co"># gratia::appraise(rh_modG)</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="co"># # Use gratia::draw to show effects</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="co"># gratia::draw(rh_modG)</span></span></code></pre></div>
<p>Okay, so the model isn’t the greatest for a few reasons (can you list
some?). However, for fun–and so we can see how “random intercepts” work
with HGAMs–let’s plot some predictions. We’ll also do a quick comparison
of fitted vs. observed to gauge how well the models are performing.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># setup prediction data. This is a little tricky because for ggplot, we only</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co"># want one latitude/longitude for each ecoregion AND we want to make sure the</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># correct latitude/longitudes get paired with their respective ecoregions. Doing</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co"># this with a left_join()</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>rh_pred_df <span class="ot">&lt;-</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="fu">with</span>(</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    weather,</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>      <span class="fu">expand.grid</span>(</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>        <span class="at">Year =</span> <span class="dv">2010</span><span class="sc">:</span><span class="dv">2019</span>,</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>        <span class="at">Day =</span> <span class="fu">median</span>(Day),  <span class="co"># Only using the median day here!</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>        <span class="at">Veg_Type =</span> <span class="fu">unique</span>(Veg_Type)</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>      ),</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>      weather <span class="sc">%&gt;%</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>        <span class="fu">filter</span>(Day <span class="sc">==</span> <span class="fu">median</span>(Day)) <span class="sc">%&gt;%</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>        <span class="fu">group_by</span>(Veg_Type) <span class="sc">%&gt;%</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>        <span class="fu">filter</span>(Station_ID <span class="sc">%in%</span> <span class="fu">sample</span>(Station_ID, <span class="dv">1</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>        <span class="fu">select</span>(<span class="fu">c</span>(Veg_Type, Lat, Long, Year, RH_per_min)),</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>     <span class="at">keep =</span> <span class="cn">FALSE</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>    )</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>  )</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a><span class="co"># make the prediction, add this and a column of standard errors to the prediction</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="co"># data.frame. Predictions are on the log scale.</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>rh_modG_pred <span class="ot">&lt;-</span> <span class="fu">cbind</span>(rh_pred_df,</span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>                       <span class="fu">predict</span>(rh_modG, </span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>                               rh_pred_df, </span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>                               <span class="at">se.fit =</span> <span class="cn">TRUE</span>, </span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>                               <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a><span class="co"># make the prediction plots</span></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> rh_modG_pred) <span class="sc">+</span></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Veg_Type) <span class="sc">+</span></span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> fit <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se.fit, </span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>                  <span class="at">ymax =</span> fit <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se.fit, </span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a>                  <span class="at">x =</span> Year, </span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>                  <span class="at">group =</span> Veg_Type),</span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;grey80&quot;</span>) <span class="sc">+</span></span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, </span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a>                <span class="at">y =</span> fit, </span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a>                <span class="at">group =</span> Veg_Type),</span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;darkred&quot;</span>) <span class="sc">+</span></span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2013</span>, <span class="dv">2016</span>, <span class="dv">2019</span>)) <span class="sc">+</span> </span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Year&quot;</span>,</span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Minimum Relative Humidity (%)&quot;</span>) <span class="sc">+</span> </span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Model G&quot;</span>)</span></code></pre></div>
<p><img src="06-A-Hierarchical-Generalized-Additive-Models_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Now, let&#39;s create a data.frame comparing observed vs. fitted values</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>rh_modG_predVSobs <span class="ot">&lt;-</span> </span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="fu">transform</span>(rh_modG_pred, </span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>            <span class="at">modG =</span> <span class="fu">predict</span>(rh_modG, </span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>                           rh_modG_pred,</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>                           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="co"># Plot observed vs. fitted values. This is a &quot;quick&quot; way to see how well</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co"># the model predicted the data.</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="fu">ggplot</span>(rh_modG_predVSobs,</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> modG, </span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>           <span class="at">y =</span> RH_per_min)) <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Veg_Type) <span class="sc">+</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">&quot;gold&quot;</span>,</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Predicted RH&quot;</span>, <span class="at">y=</span><span class="st">&quot;Observed RH&quot;</span>) <span class="sc">+</span> </span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Model G&quot;</span>)</span></code></pre></div>
<p><img src="06-A-Hierarchical-Generalized-Additive-Models_files/figure-html/unnamed-chunk-5-2.png" width="672" /></p>
<p><strong>On your own, interpret these prediction plots.</strong>
Remember the values we fed the predict() function when you’re
interpreting. For instance, what does it mean that we only used the
median Julian day in these predictions? Does it matter that we only used
one randomly-selected weather station?</p>
</div>
<div id="random-slope-model-gs" class="section level3">
<h3>“Random Slope”: Model GS</h3>
<p>Let’s try for a</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Create model GS using bam()</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>rh_modGS <span class="ot">&lt;-</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="fu">bam</span>(</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    RH_per_min <span class="sc">~</span> <span class="fu">s</span>(Year) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>      <span class="fu">s</span>(Year, Veg_Type, <span class="at">bs =</span> <span class="st">&quot;fs&quot;</span>, <span class="at">m =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>      <span class="fu">s</span>(Day, <span class="at">bs =</span> <span class="st">&quot;cc&quot;</span>) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>      <span class="fu">te</span>(Long, Lat),</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="st">&quot;log&quot;</span>),</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    <span class="at">data =</span> weather,</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;fREML&quot;</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  )</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co"># # Some basic model diagnostics</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="co"># summary(rh_modGS)</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="co"># gam.check(rh_modGS)</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="co"># gratia::appraise(rh_modGS)</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="co"># # Use gratia::draw to show effects. This is slow, so commenting out</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a><span class="co"># gratia::draw(rh_modGS)</span></span></code></pre></div>
<p><strong>On your own, run the model diagnostics and compare to
diagnostics from Model G.</strong> Are there improvements, and if so,
where do you see them? Should we consider increasing “k” for any of the
smoothers?</p>
<p>To be thorough, let’s also plot predictions and compare fitted to
observed:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># make the prediction, add this and a column of standard errors to the prediction</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co"># data.frame. Predictions are on the log scale.</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>rh_modGS_pred <span class="ot">&lt;-</span> <span class="fu">cbind</span>(rh_pred_df,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>                       <span class="fu">predict</span>(rh_modGS, </span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>                               rh_pred_df, </span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>                               <span class="at">se.fit =</span> <span class="cn">TRUE</span>, </span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>                               <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co"># make the prediction plots</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> rh_modGS_pred) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Veg_Type) <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> fit <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se.fit, </span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>                  <span class="at">ymax =</span> fit <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se.fit, </span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>                  <span class="at">x =</span> Year, </span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>                  <span class="at">group =</span> Veg_Type),</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;grey80&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, </span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>                <span class="at">y =</span> fit, </span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>                <span class="at">group =</span> Veg_Type),</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;darkred&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2013</span>, <span class="dv">2016</span>, <span class="dv">2019</span>)) <span class="sc">+</span> </span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Year&quot;</span>,</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Minimum Relative Humidity (%)&quot;</span>) <span class="sc">+</span> </span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Model GS&quot;</span>)</span></code></pre></div>
<p><img src="06-A-Hierarchical-Generalized-Additive-Models_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Now, let&#39;s create a data.frame comparing observed vs. fitted values</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>rh_modGS_predVSobs <span class="ot">&lt;-</span> </span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="fu">transform</span>(rh_modGS_pred, </span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>            <span class="at">modGS =</span> <span class="fu">predict</span>(rh_modGS, </span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>                           rh_modGS_pred,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>                           <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="co"># Plot observed vs. fitted values. This is a &quot;quick&quot; way to see how well</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="co"># the model predicted the data.</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="fu">ggplot</span>(rh_modGS_predVSobs,</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> modGS, </span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>           <span class="at">y =</span> RH_per_min)) <span class="sc">+</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Veg_Type) <span class="sc">+</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">&quot;gold&quot;</span>,</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Predicted RH&quot;</span>, <span class="at">y=</span><span class="st">&quot;Observed RH&quot;</span>) <span class="sc">+</span> </span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Model GS&quot;</span>)</span></code></pre></div>
<p><img src="06-A-Hierarchical-Generalized-Additive-Models_files/figure-html/unnamed-chunk-7-2.png" width="672" /></p>
<p>Hmmm. The predictions are fairly different now. Also, it looks like
some predictions are tightening up (e.g., compare Flint Hills fitted
vs. observed between Models G and GS) while others got worse (can you
spot any?).</p>
</div>
<div id="comparing-hgams" class="section level3">
<h3>Comparing HGAMs</h3>
<p>We learned from the Pedersen et al. (2019) paper that we can use AIC
to compare HGAMs, which is awesome! But–model selection via AIC should
not be our stopping point. In this section, we’re going to dip our toes
into cross validation to compare the <em>predictive power</em> of
HGAMs.</p>
<p>But first, let’s just see what AIC(c) has to say about our two
HGAMs:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">model.sel</span>(<span class="fu">list</span>(<span class="at">GS =</span> rh_modGS, <span class="at">G =</span> rh_modG))</span></code></pre></div>
<pre><code>## Model selection table 
##    (Int) s(Day,&quot;cc&quot;) s(Yer) s(Yer,Veg_Typ,&quot;fs&quot;,2) te(Lng,Lat) s(Veg_Typ,&quot;re&quot;)
## GS 3.753           +      +                     +           +                
## G  3.759           +      +                                 +               +
##     df    logLik     AICc   delta weight
## GS 101 -430700.9 861605.0    0.00      1
## G   48 -431945.3 863988.2 2383.22      0
## Models ranked by AICc(x)</code></pre>
<p>We have a <em>very</em> clear winner per AICc rankings: model GS.</p>
<p>Let’s check on the cross validation.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Create training and testing data.frames</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>train_df <span class="ot">&lt;-</span> </span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="fu">sample_n</span>(weather <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()), </span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>           <span class="fu">ceiling</span>(<span class="fu">nrow</span>(weather)<span class="sc">/</span><span class="dv">10</span>))</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>test_df <span class="ot">&lt;-</span> </span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  <span class="fu">anti_join</span>(weather <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()), </span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>            train_df, <span class="at">by =</span> <span class="st">&quot;id&quot;</span>)</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co"># train models</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>rh_modG_train <span class="ot">&lt;-</span> </span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>  <span class="fu">bam</span>(</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    RH_per_min <span class="sc">~</span> <span class="fu">s</span>(Year) <span class="sc">+</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>      <span class="fu">s</span>(Day, <span class="at">bs =</span> <span class="st">&quot;cc&quot;</span>) <span class="sc">+</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>      <span class="fu">te</span>(Long, Lat) <span class="sc">+</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>      <span class="fu">s</span>(Veg_Type, <span class="at">bs =</span> <span class="st">&quot;re&quot;</span>),</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="st">&quot;log&quot;</span>),</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>    <span class="at">data =</span> train_df,</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;fREML&quot;</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  )</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>rh_modGS_train <span class="ot">&lt;-</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>  <span class="fu">bam</span>(</span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>    RH_per_min <span class="sc">~</span> <span class="fu">s</span>(Year) <span class="sc">+</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>      <span class="fu">s</span>(Year, Veg_Type, <span class="at">bs =</span> <span class="st">&quot;fs&quot;</span>, <span class="at">m =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a>      <span class="fu">s</span>(Day, <span class="at">bs =</span> <span class="st">&quot;cc&quot;</span>) <span class="sc">+</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a>      <span class="fu">te</span>(Long, Lat),</span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="st">&quot;log&quot;</span>),</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>    <span class="at">data =</span> weather,</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&quot;fREML&quot;</span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>  )  </span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="co"># Root mean square error and mean absolute error</span></span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">Model =</span> <span class="fu">c</span>(<span class="st">&quot;G&quot;</span>, <span class="st">&quot;GS&quot;</span>),</span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a>           <span class="at">RMSE =</span> <span class="fu">c</span>(<span class="fu">rmse</span>(rh_modG_train, test_df), </span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a>                    <span class="fu">rmse</span>(rh_modGS_train, test_df)),</span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a>           <span class="at">MAE =</span> <span class="fu">c</span>(<span class="fu">mae</span>(rh_modG_train, test_df), </span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a>                    <span class="fu">mae</span>(rh_modGS_train, test_df)))</span></code></pre></div>
<pre><code>##   Model     RMSE      MAE
## 1     G 44.09662 40.74003
## 2    GS 44.08402 40.73108</code></pre>
<p>Oof! Looks like both our (quick and dirty) cross-validation tests
show the models have negligible differences in predictive ability. Just
goes to show that we need to assess models from multiple angles.</p>
</div>
<div id="try-other-models" class="section level3">
<h3>Try other models!</h3>
<p><strong>On your own, try some different model formulations (e.g.,
model I, model GI, etc.) from Pedersen et al. (2019).</strong> Do you
see any clear patterns?</p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
